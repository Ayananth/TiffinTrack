{% extends "./base.html" %}
{% load static %}
{% block content %}


    <!-- page head section starts -->
    <section class="page-head-section">
        <div class="container page-heading">
            <h2 class="h3 mb-3 text-white text-center">Payment</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb flex-lg-nowrap justify-content-center justify-content-lg-star">
                    <li class="breadcrumb-item">
                        <a href="{% url 'user-home' %}"><i class="ri-home-line"></i>Home</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Payment</li>
                </ol>
            </nav>
        </div>
    </section>
    <!-- page head section end -->
{% include './messages.html' %}

<!-- account section starts -->
<section class="account-section section-b-space pt-0">
    <div class="container">
        <div class="layout-sec">
            <div class="row justify-content-center">
                <div class="col-lg-8 col-xl-6">
                    <div class="order-summery-section">
                        <div class="checkout-detail">
                            <!-- Delivery Address -->
                            <div class="cart-address-box">
                                <div class="add-img">
                                    <img class="img-fluid img" src="{% static 'frontend/assets/images/home.png' %}" alt="home">
                                </div>
                                <div class="add-content">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h5 class="dark-text deliver-place">
                                            Deliver to: {{subscription.address.address_line}}
                                        </h5>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Summary Title -->
                            <h3 class="fw-semibold dark-text checkout-title">Order Summary</h3>



                            <!-- Bill Details -->

                            <div class="bill-details mb-4">
                                <div class="sub-total">
                                    <h6 class="content-color fw-normal">Selected Menu</h6>
                                    <h6 class="fw-semibold">{{subscription.menu_category.name}}</h6>
                                </div>
                                <div class="sub-total">
                                    <h6 class="content-color fw-normal">Restaurant</h6>
                                    <h6 class="fw-semibold">{{subscription.restaurant.restaurant_name}}</h6>
                                </div>
                                <div class="sub-total">
                                    <h6 class="content-color fw-normal">Start Date</h6>
                                    <h6 class="fw-semibold">{{subscription.start_date.date}}</h6>
                                </div>
                                <div class="sub-total">
                                    <h6 class="content-color fw-normal">End Date</h6>
                                    <h6 class="fw-semibold">{{subscription.end_date.date}}</h6>
                                </div>
                                <div class="sub-total">
                                    <h6 class="content-color fw-normal">Number of Days</h6>
                                    <h6 class="fw-semibold">{{subscription.num_days}}</h6>
                                </div>
                                <div class="sub-total">
                                    <h6 class="content-color fw-normal">Per Day Price</h6>
                                    <h6 class="fw-semibold">Rs.{{subscription.menu_category.total_price}}</h6>
                                </div>
                                <div class="sub-total">
                                    <h6 class="content-color fw-normal">Sub Total</h6>
                                    <h6 class="fw-semibold">Rs.{{subscription.item_total}}</h6>
                                </div>
                                {% if subscription.wallet_amount_used %}
                                    <div class="sub-total">
                                        <h6 class="content-color fw-normal">Wallet Amount Applied</h6>
                                        <h6 class="fw-semibold text-success">Rs.{{subscription.wallet_amount_used}}</h6>
                                    </div>
                                {%endif%}
                                {% if subscription.coupon %}
                                    <div class="sub-total">
                                        <h6 class="content-color fw-normal">Coupon Applied</h6>
                                        <h6 class="fw-semibold text-success">Rs.{{subscription.coupon.cashback_amount}}</h6>
                                    </div>
                                {%endif%}


                            <!-- Wallet Payment Option
                            <div class="payment-section mt-0 p-0">
                                <div class="wallet-option p-3 border rounded">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="use_wallet" id="use_wallet">
                                        <label class="form-check-label fw-medium" for="use_wallet" id="wallet_label">
                                            Use wallet amount: Rs.{{ wallet_amount }}
                                        </label>
                                    </div>
                                </div>
                            </div> -->
                            {% if subscription.wallet_amount_used %}

                            <div class="promo-code position-relative mb-4">
                                <input type="text" class="form-control code-form-control" placeholder="Wallet amount Used: Rs.{{ subscription.wallet_amount_used }}">
                                <form action="{% url 'remove_wallet' %}" method="post">
                                    {%csrf_token%}
                                    <input type="hidden" name="subscription_id" value="{{subscription.id}}">
                                    <button type="submit" class="btn theme-btn apply-btn mt-0">Remove</button>
                                </form>
                            </div>

                            {%else%}



                            <div class="promo-code position-relative mb-4">
                                <input type="text" class="form-control code-form-control" placeholder="Wallet Balance: Rs.{{ wallet_amount }}">
                                <form action="{% url 'use_wallet' %}" method="post">
                                    {%csrf_token%}
                                    <input type="hidden" name="subscription_id" value="{{subscription.id}}">
                                    {% if wallet_amount > 0%}
                                        <button type="submit" class="btn theme-btn apply-btn mt-0">USE</button>
                                    {%endif%}
                                </form>
                            </div>

                            {%endif%}

                            
                            <!-- Promo Code -->

                            {% if not subscription.coupon %}
                                <form id="coupon-form" method="post" action="{% url 'apply-coupon' %}">
                                    {%csrf_token%}
                                    <div class="promo-code position-relative mb-4">
                                        <input type="text" class="form-control code-form-control" id="coupon_code" name="coupon_code" placeholder="Enter coupon code" required />
                                        <input type="hidden" name="subscription_id" value="{{subscription.id}}">
                                        <button type="submit" class="btn theme-btn apply-btn mt-0">Apply</button>
                                    </div>
                                </form>
                            {%else%}

                                <form id="coupon-form" method="post" action="{% url 'remove-coupon' %}">
                                    {%csrf_token%}
                                    <div class="promo-code position-relative mb-4">
                                        <input type="text" class="form-control code-form-control" id="coupon_code" name="coupon_code" placeholder="{{subscription.coupon.cashback_amount}}"/>
                                        <input type="hidden" name="subscription_id" value="{{subscription.id}}">
                                        <button type="submit" class="btn theme-btn apply-btn mt-0">Remove</button>
                                    </div>
                                </form>

                            {%endif%}



                            <div id="coupon-message"></div>


  



                                <hr>
                                <div class="grand-total">
                                    <h6 class="fw-bold dark-text">Total Amount</h6>
                                    <h6 class="fw-bold amount" id="total_amount_display">Rs. {{subscription.final_total}}</h6>
                                </div>
                            </div>

                            <!-- Payment Form -->
                            <form method="post" id="payment" action="{% url 'payment' subscription.id%}">
                                {% csrf_token %}
                                <input type="hidden" name="paid_amount" value="{{subscription.total_amount}}">
                                <input type="hidden" id="wallet_amount" name="wallet_amount" value="">
                                <button type="submit" id="payment_confirm" class="btn theme-btn restaurant-btn w-100 rounded-2">
                                    Proceed to Payment
                                </button>
                            </form>

                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- account section end -->


<!-- <script>
// Get CSRF token from cookie (Django default)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.getElementById('coupon-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const couponCode = document.getElementById('coupon_code').value;
    const orderTotal = document.getElementById('order_total').value;
    const csrfToken = getCookie('csrftoken');

    fetch('/coupons/apply/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
        },
        body: new URLSearchParams({
            coupon_code: couponCode,
            order_total: orderTotal,
        }),
    })
    .then(response => response.json())
    .then(data => {
        const messageDiv = document.getElementById('coupon-message');
        if (data.success) {
            messageDiv.style.color = 'green';
            messageDiv.textContent = data.success;
        } else if (data.error) {
            messageDiv.style.color = 'red';
            messageDiv.textContent = data.error;
        }
    })
    .catch(error => {
        console.error('Error applying coupon:', error);
    });
});
</script> -->





{%endblock%}